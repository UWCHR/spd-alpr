---
title: "SPD ALPR Analysis"
author:
- '[Destiny Moreno](https://github.com/dmorenouw)'
- '[Phil Neff](https://github.com/philneff)'
date: "20 April, 2023"
output:
  html_document:
    html_preview: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
    code_folding: hide
  pdf_document:
    toc: no
    toc_depth: '3'
---

```{r import, echo=FALSE, message=FALSE, include=TRUE}

library(pacman)
p_load(tidyverse) 
p_load(lubridate) 
p_load(ggmap) 
p_load(ggrepel)
p_load(scales)
p_load(leaflet)
p_load(leaflet.extras)

options(scipen = 999)

df <- read_delim(here::here('write', 'input', 'spd-alpr-pub.csv.gz'), delim='|',
                    col_types = cols(dt = col_datetime(format="%m/%d/%Y - %H:%M:%S")
                                  ))

df <- df %>% 
  mutate(year = year(dt),
         month = month(dt),
         day = day(dt),
         hour = hour(dt),
         minute = minute(dt),
         wday = wday(dt),
         date = ymd(paste(year, month, day, sep='-')),
         day_name = lubridate::wday(date, label = TRUE, abbr = FALSE))

ampm <- function(hr) paste((hr-1) %% 12 + 1, ifelse(hr %% 24 < 12, "am", "pm"))

df$missing_address = is.na(df$address)

labels <- read_delim(here::here('write', 'input', 'labels.csv'))

ggkey = Sys.getenv("GEOCODE_API_KEY")
register_google(key = ggkey)


```

# Introduction

The data set captures one week of Seattle Police Department ALPR activity obtained through public records requests.

# Variables

## License Plate Reads

Each time a license plate is detected by the ALPR device, the system records the date and time of the detection and the location of the license plate hit, including the exact longitude and latitude coordinates and the full address. This information revealed insight about the frequency and intensity of the surveillance program and the areas where it is used.


```{r descriptive stats:reads, echo=FALSE, fig.align='center', message=FALSE, warning=FALSE}

total_reads  <- nrow(df)

dtrange <- range(df$dt)

unique_plates <- length(unique(df$plate_hash, na.rm=TRUE))
unique_plates_p <- unique_plates / total_reads *100

plate_freq <- df %>% 
  group_by(plate_hash) %>% 
  summarize(n = n()) %>% 
  mutate(freq = n/sum(n))

avg_reads <- mean(plate_freq$n)

one_read <- plate_freq %>% 
  filter(n == 1) %>% 
  nrow()
one_read_p <- one_read / unique_plates *100

multi_read <- plate_freq %>% 
  filter(n > 1) %>% 
  nrow()
multi_read_p <- multi_read / unique_plates *100



#Distribution of hits per zip code per device (including missing– there’s one zip code category thats NA and we treat NA as if it was a zipcode )  
## UPDATE: ditch the pie charts; do a table of the missingness by device. this will confirm that all missings in the 2 devices i pulled out:)
## WHAT'S MEANINGFUL TO LOOK AT: chart of missingness by device by date and time (figure 7b but add date). Beef up that device analysis section, we wanna have what distinguishes them from anotha beyond the date/time of reads 

# # *couple sentences about the bad reads, few examples, didn't clean up the data because they do represent somethin about the presence of ALPR readers
# 
# *move the note below about what onces we ditched, ie: i-5 and stuff to here

```

# Analysis 

Our data set contains `r total_reads` instances where license plates were detected by SPD's surveillance system from `r dtrange[1]` to `r dtrange[2]`. Of the license plates captured, `r one_read` reads, which accounts for `r round(one_read_p, 0)`% of the total reads, were only captured once. We also found that on average, each unique license plate was captured `r round(avg_reads, 2)` times.

## Analyzing the Spatial Deployment of SPD's ALPR System

Figure 1 provides an overview of the geographic distribution of these reads. Nearly all of the non-Seattle reads are located along the journey to a prison north of Seattle. These reads were coded as "I-5". We opted to remove these reads. 

For a closer look, Figures 2, 3, and 4 depict zoomed-in maps that highlights areas with the highest concentration of ALPR reads through brighter colors. The most read-dense areas are located near SPD precincts. Notably, there are no reads in West Seattle and very few reads in East Capitol Hill and waterfront neighborhoods like Magnolia.


### Figure 1: Overview of All Reads

```{r leaflet map all reads,  echo=FALSE, fig.align='center', message=FALSE, warning=FALSE}
#See if Phil still wants the basic plot map here, or just the leaflet interactive plot map!

plot_color = "#4b2e83"

#Build  map 
leaflet_all_reads <- leaflet(df) %>% 
  addProviderTiles(providers$CartoDB.VoyagerLabelsUnder) %>%
  addCircleMarkers(
    radius = 2,
    color = "black",
    fillColor = plot_color,
    stroke = TRUE,  weight = .3,
    fillOpacity = 0.1) %>%
  addMarkers(
    lng = -122.3345865, lat = 47.70302542,
    label = "Seattle Police Department, North Precinct",
    labelOptions = labelOptions(noHide = T, direction = "bottom",
      style = list(
        "color" = "black",
        "font-family" = "sans serif",
        "font-style" = "bold",
        "box-shadow" = "3px 3px rgba(0,0,0,0.25)",
        "font-size" = "12px",
        "border-color" = "rgba(0,0,0,0.5)"))) %>%
  addMarkers(
    lng = -122.299097, lat = 47.66211867,
    label = "University Village",
    labelOptions = labelOptions(noHide = T, direction = "bottom",
      style = list(
        "color" = "black",
        "font-family" = "san serif",
        "font-style" = "bold",
        "box-shadow" = "3px 3px rgba(0,0,0,0.25)",
        "font-size" = "12px",
        "border-color" = "rgba(0,0,0,0.5)"))) %>%
  addMarkers(
    lng = -122.3038448, lat = 47.53708176,
    label = "King County Airport",
    labelOptions = labelOptions(noHide = T, direction = "bottom",
      style = list(
        "color" = "black",
        "font-family" = "sans serif",
        "font-style" = "bold",
        "box-shadow" = "3px 3px rgba(0,0,0,0.25)",
        "font-size" = "12px",
        "border-color" = "rgba(0,0,0,0.5)"))) %>%
  addMarkers(
    lng = -122.3159617, lat = 47.67653678,
    label = "Roosevelt Light Rail Station",
    labelOptions = labelOptions(noHide = T, direction = "bottom",
      style = list(
        "color" = "black",
        "font-family" = "sans serif",
        "font-style" = "bold",
        "box-shadow" = "3px 3px rgba(0,0,0,0.25)",
        "font-size" = "12px",
        "border-color" = "rgba(0,0,0,0.5)"))) %>%
    addMarkers(
    lng = -122.3364106, lat = 47.61620391,
    label = "Seattle Police Department, West Precinct",
    labelOptions = labelOptions(noHide = T, direction = "bottom",
      style = list(
        "color" = "black",
        "font-family" = "sans serif",
        "font-style" = "bold",
        "box-shadow" = "3px 3px rgba(0,0,0,0.25)",
        "font-size" = "12px",
        "border-color" = "rgba(0,0,0,0.5)"))) %>%
  addMarkers(
    lng = -121.9996418, lat = 47.84514158,
    label = "Monroe Correctional Complex",
    labelOptions = labelOptions(noHide = T, direction = "bottom",
      style = list(
        "color" = "black",
        "font-family" = "sans serif",
        "font-style" = "bold",
        "box-shadow" = "3px 3px rgba(0,0,0,0.25)",
        "font-size" = "12px",
        "border-color" = "rgba(0,0,0,0.5)"))) 

leaflet_all_reads

```

### Figure 2: Heat Map of ALPR Reads

License plates are more likely to be captured on camera in the vicinity of SPD precincts.

```{r heatmap all reads,  echo=FALSE, fig.align='center', message=FALSE, warning=FALSE}

seattle <- ggmap(get_googlemap(center = c(lon = -122.332115, 
           lat = 47.636462),zoom = 11, scale = 1, 
           maptype ='roadmap')
           ) 

# Plot all observations onto Seattle map
heatmap_all_reads <- seattle + 
  stat_density2d(aes(x = lon, y = lat, 
                     fill = ..level.., alpha = ..level..), 
                 bins = 100, data = df, geom = "polygon") + 
  scale_fill_distiller(palette = "Spectral") +
  theme_void() + 
  theme(legend.position="none",
             plot.caption = element_text(face = "italic")) + 
  labs(caption = "Source: SPD")  

heatmap_all_reads

```

### Figure 3: Heat Map of ALPR Reads in Downtown Seattle

While license plates all throughout downtown are likely to be captured by the ALPR system, we have observed that specific neighborhoods, such as East Capitol Hill, appear to go entirely unmonitored.

```{r downtown heat map, echo=FALSE, message=FALSE, warning=FALSE}

heatmap_downtown <- ggmap(
  get_googlemap(center = c(lon = -122.334480, lat = 47.605026), 
                zoom = 15, scale = 1, maptype ='roadmap', color = 'color')) +
  stat_density2d(
    aes(x = lon, y = lat, fill = ..level.., alpha = ..level..),
    data = df,geom = "polygon") + 
  scale_fill_distiller(palette = "Spectral") +
   theme_void()  +
  theme(legend.position="none",
             plot.caption = element_text(face = "italic")) + 
    labs(caption = "Source: SPD") 
  
heatmap_downtown

```

### Figure 4: Heat Map of ALPR Reads in North Seattle

SPD's North Precinct is located near the Northgate Transit Center, which suggests that the higher frequency of reads in this area may be due to patrol cars traveling to and from police headquarters. 

```{r spd north heat map, echo=FALSE, message=FALSE, warning=FALSE}

heatmap_spdnorth <- ggmap(
  get_googlemap(
    center = c(lon = -122.334724, lat = 47.702875), 
    zoom = 15, scale = 1, maptype ='roadmap', color = 'color')) + 
  stat_density2d(
    aes(x = lon, y = lat, fill = ..level.., alpha = ..level..),
    bins = 1000, data = df,
    geom = "polygon") + 
  scale_fill_distiller(palette = "Spectral") +
  geom_point(
    aes(x = lon, y = lat), data = labels, color = "black", fill="white",
    shape= 23, size = 2, stroke = 1) +
  geom_label_repel(
    aes(lon, lat, label = label),
    data=labels, min.segment.length = unit(0, 'lines')) +
  theme_void()  +
  theme(
    legend.position="none",
    plot.caption = element_text(face = "italic")) + 
  labs(caption = "Source: SPD") 

heatmap_spdnorth

```


## Investigating the ALPR Devices in Use

```{r describe device and reads, echo=FALSE, message=FALSE, include=FALSE}

reads_per_device <- df %>% 
  group_by(device) %>% 
  summarize(n = n())

max_reads_per_device <- max(reads_per_device$n)

avg_reads_per_device <- mean(reads_per_device$n)

device_count <- length(unique(reads_per_device$device))

reads_missing_address <- df %>%
  filter(missing_address %in% c('TRUE'))

devices_missing_address = reads_missing_address %>%
  filter(device== "SPD2020537MDC" | device == "BXH9904 SPD2020627MDC")  %>%
  nrow()
devices_missing_address_p = devices_missing_address / total_reads * 100

peo_device_reads = sum(df$device== "PEO508459" | df$device == "PEOATG508533") 
peo_device_reads_p = peo_device_reads / total_reads * 100


```

The data set consists of `r device_count` devices. Each device captured an average of `r round(avg_reads_per_device, 0)` license plates, with the most device capturing `r max_reads_per_device` plates. Two devices were completely missing addresses, comprising `r round(devices_missing_address_p, 0)`% of all reads in the data. Another two devices were attached to parking enforcement officer vehicles (PEO). Reads from PEO devices account for  `r round(peo_device_reads_p, 0)`% of reads in the data set. 

### Figure 5: Tracking the Movements of ALPR Devices
The path of one active ALPR device is depicted below. The maps show where the device captured license plates on camera throughout the week 

```{r map device path, echo=FALSE, message=FALSE, warning=FALSE}

#once i finish priority edits, troubleshoot why my get google map call isn't working (panels are way too small rn)

#phil gave go ahead to just manually add the day names, take from code below. can keep trying once higher priority tasks are finished (also now that geom_path was approved, change legend)

base <- get_map("seattle, washington", zoom = 11, maptype = c("roadmap"))

device_M207541 <- df %>%
  arrange(device, dt) %>%
  filter(device == "M207541_Deleted_2021-10-21_22 50:42")

device_M207541_map <- ggmap(base) + 
  geom_path(data = device_M207541, aes(x = lon, y = lat, color = hour(dt),
                                       group = device)) + 
  facet_wrap(~date, strip.position = "bottom",  ncol = 3) +
  theme_void() + 
   theme(
     plot.caption = element_text(face = "italic"), 
     legend.key.width = unit(50, "pt"), 
     legend.position	= "bottom", 
     legend.justification	= "center", 
     legend.box = "horizontal",
     legend.margin = margin(6, 6, 6, 6), 
     strip.background = element_rect(colour = "black", 
                                     fill = "white", size = .2),
     strip.text.x = element_text(face = "bold", size = 10),
     panel.spacing = unit(10, "pt")) + 
    labs(
       caption = "Source: SPD",
       color = "Time of Day")

device_M207541_map

```

## Examining ALPR System Usage During the Day

```{r describe date and time, echo=FALSE, message=FALSE}

reads_per_day <- df %>% 
  group_by(wday) %>% 
  summarize(n = n()) 
max_reads_per_day <- max(reads_per_day)

reads_per_min <- df %>% 
  group_by(day, hour, minute) %>% 
  summarize(n = n()) 
max_reads_per_min <- max(reads_per_min)

```

Contrary to our expectations, SPD devices were relatively inactive during the beginning of the work day. Figures 4 and 5 show that devices collected the most data in the middle of the work day, between 12:00 pm and 6:00 pm. On the busiest day in our data set, SPD cameras captured `r max_reads_per_day` license plates. Up to `r max_reads_per_min` plates were captured in a single minute. 

### Figure 6: SPD ALPR Collection by Time of Day
ALPR activity was busiest in the middle of the day. 

```{r bar plot reads by hour, echo=FALSE, message=FALSE, warning=FALSE}

bar_reads_per_hour <- df %>%
  ggplot( aes(x=hour)) +
    geom_bar(bins = 24, binwidth=1, 
                    fill="#4b2e83", color="#4b2e83", alpha=0.9) +
  scale_y_continuous(labels = comma) +
  scale_x_continuous(labels = ampm,
    breaks = function(z) pretty(z, n = 12)) +
         theme(
            axis.title = element_text(face = "bold"),
            axis.text = element_text(face = "bold"),
            axis.text.x = element_text(margin = margin(t = .3, unit = "cm")),
           plot.caption = element_text(face = "italic")) +
   labs(y = "Reads per Hour", 
        x = "Hour of Day",
        caption = "Source: SPD")

bar_reads_per_hour


#Proportions of the bar colored by devices, see which devices are active which days 

#graphic w/devices missing location shaded in a diff way (make it gray? diagonal line? transparent? some cool way to visualize the amt of data we don't have. 

bar_reads_per_hour_missing <- df %>%
  ggplot(aes(x=hour)) +
  geom_bar(aes(fill = device),
           bins = 24, binwidth=1, alpha=0.9) +
    scale_y_continuous(labels = comma) +
    scale_x_continuous(labels = ampm,
                       breaks = function(z) pretty(z, n = 12)) +
    scale_fill_manual("Devices with Missing Address Data", 
                      values = c("SPD2020537MDC" = "red", 
                                 "BXH9904 SPD2020627MDC" = "blue")) + 
   theme(
     plot.caption = element_text(face = "italic"), 
     legend.position	= "bottom", 
     legend.justification	= "center", 
     legend.box = "horizontal",
     legend.margin = margin(6, 6, 6, 6)) + 
     labs(y = "Reads per Hour", 
        x = "Hour of Day",
        caption = "Source: SPD")

# bar_reads_per_hour_missing

```

### Figure 7: SPD ALPR Collection by Day of the Week

ALPR activity was busiest on weekdays. 
```{r bar plot reads by day, echo=FALSE, message=FALSE, warning=FALSE}

bar_reads_per_day <- df %>%
  ggplot(aes(x=wday)) +
    geom_bar( bins = 7, binwidth=.5, 
                    fill="#4b2e83", color="#4b2e83", alpha=0.9) +
  scale_y_continuous(labels = comma) +
  scale_x_continuous(breaks = seq(1,7, by = 1), labels = c(
    "Sunday","Monday","Tuesday","Wednesday","Thursday", "Friday", "Saturday")) +
         theme(
            axis.title = element_text(face = "bold"),
            axis.text = element_text(face = "bold"),
            axis.text.x = element_text(margin = margin(t = .3, unit = "cm")),
           plot.caption = element_text(face = "italic")) +
  labs(y = "Reads per Day", 
          x = "Day of the Week",
          caption = "Source: SPD") 

bar_reads_per_day

```

